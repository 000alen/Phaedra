<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>JSDoc: Source: components/Notebook/NotebookComponent.js</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link
      type="text/css"
      rel="stylesheet"
      href="styles/prettify-tomorrow.css"
    />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css" />
  </head>

  <body>
    <div id="main">
      <h1 class="page-title">
        Source: components/Notebook/NotebookComponent.js
      </h1>

      <section>
        <article>
          <pre
            class="prettyprint source linenums"
          ><code>import React, { Component } from "react";

import { readFile } from "../../API/ElectronAPI";

import PageComponent from "./PageComponent";

import {
  historyDo,
  historyRedo,
  historyUndo,
} from "../../manipulation/HistoryManipulation";
import {
  undo,
  redo,
  getPage,
  indexPage,
  getCell,
  indexCell,
  getCellContent,
  getCellData,
} from "../../manipulation/NotebookManipulation";

import { saveNotebook } from "../../NotebookIO";

/**
 * @typedef {import("../../App").AppController} AppController
 */

/**
 * @typedef {import("../../pages/NotebookPage").NotebookPageController} NotebookPageController
 */

/**
 * @typedef {import("../../manipulation/NotebookManipulation").Notebook} Notebook
 */

/**
 * @typedef {import("../../manipulation/NotebookManipulation").Command} Command
 */

/**
 * @typedef {Object} NotebookController
 * @property {Function} save
 * @property {Function} handleSelection
 * @property {Function} toggleEditing
 * @property {Function} undo
 * @property {Function} redo
 * @property {Function} do
 */

/**
 * @typedef {Object} NotebookState
 * @property {string} tabId
 * @property {AppController} appController
 * @property {NotebookPageController} pageController
 * @property {NotebookController} notebookController
 * @property {React.RefObject | undefined} statusBarRef
 * @property {Notebook} notebook
 * @property {string | undefined} notebookPath
 * @property {string | undefined} documentPath
 * @property {any | undefined} documentFile
 * @property {string | undefined} activePage
 * @property {string | undefined} activeCell
 * @property {boolean} editing
 * @property {Command[]} history
 * @property {number} historyIndex
 */

export default class NotebookComponent extends Component {
  constructor(props) {
    super(props);

    this.loadDocument = this.loadDocument.bind(this);
    this.save = this.save.bind(this);

    this.handleSelection = this.handleSelection.bind(this);
    this.toggleEditing = this.toggleEditing.bind(this);

    this.do = this.do.bind(this);
    this.undo = this.undo.bind(this);
    this.redo = this.redo.bind(this);

    const { tabId, appController, pageController, statusBarRef } = props;
    const { notebook, notebookPath } = props;

    /**
     * @type {NotebookController}
     */
    const notebookController = {
      save: this.save,
      handleSelection: this.handleSelection,
      toggleEditing: this.toggleEditing,

      undo: this.undo,
      redo: this.redo,
      do: this.do,
    };

    /**
     * @type {NotebookState}
     */
    this.state = {
      tabId: tabId,
      appController: appController,
      pageController: pageController,
      notebookController: notebookController,
      statusBarRef: statusBarRef,
      notebook: notebook,
      notebookPath: notebookPath,
      documentPath: notebook.document_path,
      documentFile: undefined,
      activePage: undefined,
      activeCell: undefined,
      editing: false,
      history: [],
      historyIndex: -1,
    };
  }

  componentDidMount() {
    if (this.state.documentPath &amp;&amp; !this.state.documentFile)
      this.loadDocument();

    let unparsedState = window.localStorage.getItem(this.state.notebook.name);

    if (unparsedState !== null) {
      let state = JSON.parse(unparsedState);
      state.appController = this.state.appController;
      state.pageController = this.state.pageController;
      state.notebookController = this.state.notebookController;
      state.statusBarRef = this.state.statusBarRef;

      if (state.documentPath &amp;&amp; state.documentFile) {
        state.documentFile.data = Uint8Array.from(state.documentFile.data);
      }

      this.setState(state);
    }
  }

  componentWillUnmount() {
    let state = { ...this.state };
    state.statusBarRef = undefined;
    window.localStorage.setItem(
      this.state.notebook.name,
      JSON.stringify(state)
    );
  }

  loadDocument() {
    readFile(this.state.documentPath).then((documentContent) => {
      this.setState((state) => {
        const documentFile = {
          url: this.state.documentPath,
          data: documentContent,
        };
        return { ...state, documentFile: documentFile };
      });
    });
  }

  save() {
    saveNotebook(this.state.notebook, this.state.notebookPath).then(
      (notebookPath) => {
        this.setState((state) => {
          return { ...state, notebookPath: notebookPath };
        });
      }
    );
  }

  /**
   *
   * @param {string} pageId
   * @param {string} cellId
   */
  handleSelection(pageId, cellId) {
    if (this.state.activePage === pageId &amp;&amp; this.state.activeCell === cellId) {
      this.state.pageController.hideCommandBox();
      this.setState((state) => {
        return { ...state, activePage: null, activeCell: null };
      });
    } else if (
      this.state.activePage === pageId &amp;&amp;
      this.state.activeCell !== cellId
    ) {
      this.state.pageController.showCommandBox();
      this.setState((state) => {
        return { ...state, activePage: pageId, activeCell: cellId };
      });
    } else {
      this.state.pageController.showCommandBox();
      this.setState((state) => {
        return { ...state, activePage: pageId, activeCell: cellId };
      });
    }
  }

  toggleEditing() {
    this.setState((state) => {
      return {
        ...state,
        editing: !state.editing,
      };
    });
  }

  /**
   *
   * @param {Function} action
   * @param {Object} args
   */
  do(action, args) {
    let notebook = this.state.notebook;
    switch (action.name) {
      case "removePage":
        const page = getPage(notebook, { pageId: args.pageId });
        const pageIndex = indexPage(notebook, {
          pageId: args.pageId,
        });
        args = { ...args, page: page, pageIndex: pageIndex };
        break;
      case "removeCell":
        const cell = getCell(notebook, {
          pageId: args.pageId,
          cellId: args.cellId,
        });
        const cellIndex = indexCell(notebook, {
          pageId: args.pageId,
          cellId: args.cellId,
        });
        args = { ...args, cell: cell, cellIndex: cellIndex };
        break;
      case "setCellContent":
        const previousContent = getCellContent(notebook, {
          pageId: args.pageId,
          cellId: args.cellId,
        });
        args = { ...args, previousContent: previousContent };
        break;
      case "setCellData":
        const previousData = getCellData(notebook, {
          pageId: args.pageId,
          cellId: args.cellId,
        });
        args = { ...args, previousData: previousData };
        break;
    }

    switch (action.name) {
      case "addEntitiesCell":
      case "addQuestionCell":
      case "addSparseQuestionCell":
      case "addGenerateCell":
      case "addWikipediaSummaryCell":
      case "addWikipediaSuggestionsCell":
      case "addWikipediaImageCell":
      case "addMeaningCell":
      case "addSynonymCell":
      case "addAntonymCell":
        if (this.state.statusBarRef === undefined)
          throw new Error("StatusBarRef is undefined.");

        const { statusBarController } = this.state.statusBarRef.current.state;
        statusBarController.showLoading();
        action(notebook, args).then((_notebook) => {
          statusBarController.hideLoading();
          args = { ...args, cellId: undefined }; // XXX
          notebook = _notebook;
        });
        break;
      default:
        notebook = action(notebook, args);
        break;
    }

    let { history, historyIndex } = this.state;

    const newHistoryInformation = historyDo(history, historyIndex, {
      ...args,
      action: action.name,
    });

    this.setState((state) => {
      return {
        ...state,
        ...newHistoryInformation,
        notebook: notebook,
      };
    });
  }

  undo() {
    let { notebook, history, historyIndex } = this.state;
    const [command, newHistoryInformation] = historyUndo(history, historyIndex);
    const newNotebook = undo(notebook, command);

    this.setState((state) => {
      return {
        ...state,
        ...newHistoryInformation,
        notebook: newNotebook,
      };
    });
  }

  redo() {
    let { notebook, history, historyIndex } = this.state;
    const [command, newHistoryInformation] = historyRedo(history, historyIndex);
    const newNotebook = redo(notebook, command);

    this.setState((state) => {
      return {
        ...state,
        ...newHistoryInformation,
        notebook: newNotebook,
      };
    });
  }

  render() {
    return (
      &lt;div className="notebook" id="notebook">
        {this.state.notebook.pages.map((page) => (
          &lt;PageComponent
            key={page.id}
            id={page.id}
            pageController={this.state.pageController}
            notebookController={this.state.notebookController}
            data={page.data}
            document={this.state.documentFile}
            cells={page.cells}
            active={this.state.activePage === page.id}
            activeCell={this.state.activeCell}
            editing={this.state.editing}
          />
        ))}
      &lt;/div>
    );
  }
}
</code></pre>
        </article>
      </section>
    </div>

    <nav>
      <h2><a href="index.html">Home</a></h2>
      <h3>Global</h3>
      <ul>
        <li><a href="global.html#addAntonymCell">addAntonymCell</a></li>
        <li><a href="global.html#addCell">addCell</a></li>
        <li><a href="global.html#addEntitiesCell">addEntitiesCell</a></li>
        <li><a href="global.html#addGenerateCell">addGenerateCell</a></li>
        <li><a href="global.html#addMeaningCell">addMeaningCell</a></li>
        <li><a href="global.html#addMessageBar">addMessageBar</a></li>
        <li><a href="global.html#addPage">addPage</a></li>
        <li><a href="global.html#addQuestionCell">addQuestionCell</a></li>
        <li>
          <a href="global.html#addSparseQuestionCell">addSparseQuestionCell</a>
        </li>
        <li><a href="global.html#addSynonymCell">addSynonymCell</a></li>
        <li><a href="global.html#addTab">addTab</a></li>
        <li>
          <a href="global.html#addWikipediaImageCell">addWikipediaImageCell</a>
        </li>
        <li>
          <a href="global.html#addWikipediaSuggestionsCell"
            >addWikipediaSuggestionsCell</a
          >
        </li>
        <li>
          <a href="global.html#addWikipediaSummaryCell"
            >addWikipediaSummaryCell</a
          >
        </li>
        <li><a href="global.html#base64encode">base64encode</a></li>
        <li><a href="global.html#clipboardDo">clipboardDo</a></li>
        <li><a href="global.html#clipboardPop">clipboardPop</a></li>
        <li><a href="global.html#clipboardPush">clipboardPush</a></li>
        <li><a href="global.html#clipboardTop">clipboardTop</a></li>
        <li><a href="global.html#createCell">createCell</a></li>
        <li><a href="global.html#createCommand">createCommand</a></li>
        <li><a href="global.html#createNotebook">createNotebook</a></li>
        <li><a href="global.html#createPage">createPage</a></li>
        <li><a href="global.html#createTab">createTab</a></li>
        <li><a href="global.html#do">do</a></li>
        <li><a href="global.html#getApiUrl">getApiUrl</a></li>
        <li><a href="global.html#getCell">getCell</a></li>
        <li><a href="global.html#getCellContent">getCellContent</a></li>
        <li><a href="global.html#getCellData">getCellData</a></li>
        <li><a href="global.html#getPage">getPage</a></li>
        <li><a href="global.html#getTab">getTab</a></li>
        <li><a href="global.html#getTabContent">getTabContent</a></li>
        <li><a href="global.html#getTabTitle">getTabTitle</a></li>
        <li><a href="global.html#handleSelection">handleSelection</a></li>
        <li><a href="global.html#historyDo">historyDo</a></li>
        <li><a href="global.html#historyRedo">historyRedo</a></li>
        <li><a href="global.html#historyUndo">historyUndo</a></li>
        <li><a href="global.html#indexCell">indexCell</a></li>
        <li><a href="global.html#indexPage">indexPage</a></li>
        <li><a href="global.html#indexTab">indexTab</a></li>
        <li><a href="global.html#insertCell">insertCell</a></li>
        <li><a href="global.html#insertPage">insertPage</a></li>
        <li><a href="global.html#insertTab">insertTab</a></li>
        <li><a href="global.html#notebookFromPdf">notebookFromPdf</a></li>
        <li><a href="global.html#notebookFromText">notebookFromText</a></li>
        <li><a href="global.html#openDialog">openDialog</a></li>
        <li><a href="global.html#openFile">openFile</a></li>
        <li><a href="global.html#openJson">openJson</a></li>
        <li><a href="global.html#openPdf">openPdf</a></li>
        <li><a href="global.html#openText">openText</a></li>
        <li><a href="global.html#readFile">readFile</a></li>
        <li><a href="global.html#redo">redo</a></li>
        <li><a href="global.html#removeCell">removeCell</a></li>
        <li><a href="global.html#removeMessageBar">removeMessageBar</a></li>
        <li><a href="global.html#removePage">removePage</a></li>
        <li><a href="global.html#removeTab">removeTab</a></li>
        <li><a href="global.html#saveDialog">saveDialog</a></li>
        <li><a href="global.html#saveNotebook">saveNotebook</a></li>
        <li><a href="global.html#selectTab">selectTab</a></li>
        <li><a href="global.html#setApiUrl">setApiUrl</a></li>
        <li><a href="global.html#setCellContent">setCellContent</a></li>
        <li><a href="global.html#setCellData">setCellData</a></li>
        <li><a href="global.html#setLoadingText">setLoadingText</a></li>
        <li><a href="global.html#setTabContent">setTabContent</a></li>
        <li><a href="global.html#setTabTitle">setTabTitle</a></li>
        <li><a href="global.html#tabsDo">tabsDo</a></li>
        <li><a href="global.html#undo">undo</a></li>
        <li><a href="global.html#undoAddAntonymCell">undoAddAntonymCell</a></li>
        <li><a href="global.html#undoAddCell">undoAddCell</a></li>
        <li>
          <a href="global.html#undoAddEntitiesCell">undoAddEntitiesCell</a>
        </li>
        <li>
          <a href="global.html#undoAddGenerateCell">undoAddGenerateCell</a>
        </li>
        <li><a href="global.html#undoAddMeaningCell">undoAddMeaningCell</a></li>
        <li><a href="global.html#undoAddPage">undoAddPage</a></li>
        <li>
          <a href="global.html#undoAddQuestionCell">undoAddQuestionCell</a>
        </li>
        <li>
          <a href="global.html#undoAddSparseQuestionCell"
            >undoAddSparseQuestionCell</a
          >
        </li>
        <li><a href="global.html#undoAddSynonymCell">undoAddSynonymCell</a></li>
        <li>
          <a href="global.html#undoAddWikipediaImageCell"
            >undoAddWikipediaImageCell</a
          >
        </li>
        <li>
          <a href="global.html#undoAddWikipediaSuggestionsCell"
            >undoAddWikipediaSuggestionsCell</a
          >
        </li>
        <li>
          <a href="global.html#undoAddWikipediaSummaryCell"
            >undoAddWikipediaSummaryCell</a
          >
        </li>
        <li><a href="global.html#undoInsertCell">undoInsertCell</a></li>
        <li><a href="global.html#undoInsertPage">undoInsertPage</a></li>
        <li><a href="global.html#undoRemoveCell">undoRemoveCell</a></li>
        <li><a href="global.html#undoRemovePage">undoRemovePage</a></li>
        <li><a href="global.html#undoSetCellContent">undoSetCellContent</a></li>
        <li><a href="global.html#undoSetCellData">undoSetCellData</a></li>
        <li><a href="global.html#writeFile">writeFile</a></li>
      </ul>
    </nav>

    <br class="clear" />

    <footer>
      Documentation generated by
      <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Fri Oct 15
      2021 19:50:48 GMT-0300 (Chile Summer Time)
    </footer>

    <script>
      prettyPrint();
    </script>
    <script src="scripts/linenumber.js"></script>
  </body>
</html>
